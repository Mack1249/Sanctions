Private Sub Worksheet_Change(ByVal Target As Range)
    Dim rngDropdown As Range
    Dim oldValue As String
    Dim newValue As String
    Dim DelimiterType As String
    Dim DelimiterCount As Integer
    Dim TargetType As Integer
    Dim i As Integer
    Dim arr() As String

    DelimiterType = Chr(10)
    
    ' ðŸ”’ Lock changes to H2:L50000
    If Not Intersect(Target, Me.Range("H2:L50000")) Is Nothing Then
        Application.EnableEvents = False
        Application.Undo
        Application.EnableEvents = True
        Exit Sub
    End If

    If Target.Count > 1 Then Exit Sub
    On Error Resume Next

    Set rngDropdown = Cells.SpecialCells(xlCellTypeAllValidation)
    On Error GoTo exitError

    If rngDropdown Is Nothing Then GoTo exitError

    If Not Intersect(Target, rngDropdown) Is Nothing Then
        TargetType = 0
        TargetType = Target.Validation.Type
        If TargetType = 3 Then  ' if validation is "list"
            Application.ScreenUpdating = False
            Application.EnableEvents = False

            newValue = Target.Value
            Application.Undo
            oldValue = Target.Value
            Target.Value = newValue

            If oldValue <> "" Then
                If newValue <> "" Then
                    If oldValue = newValue Or oldValue = newValue & Replace(DelimiterType, " ", "") Or oldValue = newValue & DelimiterType Then
                        oldValue = Replace(oldValue, DelimiterType, "")
                        oldValue = Replace(oldValue, Replace(DelimiterType, " ", ""), "")
                        Target.Value = oldValue
                    ElseIf InStr(1, oldValue, DelimiterType & newValue) Or InStr(1, oldValue, newValue & DelimiterType) Or InStr(1, oldValue, DelimiterType & newValue & DelimiterType) Then
                        arr = Split(oldValue, DelimiterType)
                        If Not IsError(Application.Match(newValue, arr, 0)) = 0 Then
                            Target.Value = oldValue & DelimiterType & newValue
                        Else
                            Target.Value = ""
                            For i = 0 To UBound(arr)
                                If arr(i) <> newValue Then
                                    Target.Value = Target.Value & arr(i) & DelimiterType
                                End If
                            Next i
                            Target.Value = Left(Target.Value, Len(Target.Value) - Len(DelimiterType))
                        End If
                    ElseIf InStr(1, oldValue, newValue & Replace(DelimiterType, " ", "")) Then
                        oldValue = Replace(oldValue, newValue, "")
                        Target.Value = oldValue
                    Else
                        Target.Value = oldValue & DelimiterType & newValue
                    End If

                    ' Clean up
                    Target.Value = Replace(Target.Value, Replace(DelimiterType, " ", "") & Replace(DelimiterType, " ", ""), Replace(DelimiterType, " ", ""))
                    Target.Value = Replace(Target.Value, DelimiterType & Replace(DelimiterType, " ", ""), Replace(DelimiterType, " ", ""))
                    If Target.Value <> "" Then
                        If Right(Target.Value, 2) = DelimiterType Then
                            Target.Value = Left(Target.Value, Len(Target.Value) - 2)
                        End If
                    End If
                    If InStr(1, Target.Value, DelimiterType) = 1 Then
                        Target.Value = Replace(Target.Value, DelimiterType, "", 1, 1)
                    End If
                    If InStr(1, Target.Value, Replace(DelimiterType, " ", "")) = 1 Then
                        Target.Value = Replace(Target.Value, Replace(DelimiterType, " ", ""), "", 1, 1)
                    End If
                    DelimiterCount = 0
                    For i = 1 To Len(Target.Value)
                        If InStr(i, Target.Value, Replace(DelimiterType, " ", "")) Then
                            DelimiterCount = DelimiterCount + 1
                        End If
                    Next i
                    If DelimiterCount = 1 Then
                        Target.Value = Replace(Target.Value, DelimiterType, "")
                        Target.Value = Replace(Target.Value, Replace(DelimiterType, " ", ""), "")
                    End If
                End If
            End If

            ' Update child dropdown dynamically if F column changes
            If Not Intersect(Target, Me.Range("F2:F50000")) Is Nothing Then
                Call UpdateChildValidation(Target)
            End If

            Application.EnableEvents = True
            Application.ScreenUpdating = True
        End If
    End If

exitError:
    Application.EnableEvents = True
End Sub
