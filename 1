' Code Generated by Sidekick is for learning and experimentation purposes only.
Private Sub Worksheet_Change(ByVal Target As Range)
    Dim sep As String: sep = Chr(10)
    Dim wsDropdown As Worksheet
    Dim dict As Object, dictChildren As Object
    Dim mapParents As Variant, mapChildren As Variant
    Dim rngF As Range, rngG As Range
    Dim cell As Range
    Dim arr As Variant, i As Long
    Dim oldVal As String, newVal As String, changedVal As String
    Dim tempList As Object
    Dim exists As Boolean
    Dim validChildren As Object, temp As Variant, fVal As String

    ' Update this if your mapping sheet is named differently
    Set wsDropdown = ThisWorkbook.Sheets("dropdowns")
    Set rngF = Me.Range("F2:F50000")
    Set rngG = Me.Range("G2:G50000")

    ' Build mapping dictionaries (for G dropdown logic)
    mapParents = wsDropdown.Range("H2:H125").Value2
    mapChildren = wsDropdown.Range("I2:I125").Value2
    Set dict = CreateObject("Scripting.Dictionary")
    For i = 1 To UBound(mapParents, 1)
        If Not dict.exists(LCase(Trim(mapParents(i, 1)))) Then
            Set dictChildren = CreateObject("Scripting.Dictionary")
            dict.Add LCase(Trim(mapParents(i, 1))), dictChildren
        Else
            Set dictChildren = dict(LCase(Trim(mapParents(i, 1))))
        End If
        If Not dictChildren.exists(LCase(Trim(mapChildren(i, 1)))) Then
            dictChildren.Add LCase(Trim(mapChildren(i, 1))), mapChildren(i, 1)
        End If
    Next i

    On Error GoTo CleanUp
    Application.EnableEvents = False

    For Each cell In Target.Cells
        ' MULTI-SELECT FOR F COLUMN
        If Not Intersect(cell, rngF) Is Nothing Then
            If cell.Validation.Type = 3 And cell.Value <> "" Then
                newVal = cell.Value
                oldVal = cell.Tag
                If oldVal = "" Then
                    cell.Value = newVal
                Else
                    arr = Split(oldVal, sep)
                    exists = False
                    For i = LBound(arr) To UBound(arr)
                        If arr(i) = newVal Then exists = True
                    Next i
                    Set tempList = CreateObject("Scripting.Dictionary")
                    If exists Then
                        ' Remove value
                        For i = LBound(arr) To UBound(arr)
                            If arr(i) <> newVal And arr(i) <> "" Then tempList(arr(i)) = 1
                        Next i
                        If tempList.Count > 0 Then
                            cell.Value = Join(tempList.Keys, sep)
                        Else
                            cell.Value = ""
                        End If
                    Else
                        ' Add value
                        cell.Value = oldVal & sep & newVal
                    End If
                End If
                cell.WrapText = True
            End If
            cell.Tag = cell.Value

            ' Update G dropdown for this row
            Set validChildren = CreateObject("Scripting.Dictionary")
            If cell.Value <> "" Then
                arr = Split(cell.Value, sep)
                For i = LBound(arr) To UBound(arr)
                    fVal = LCase(Trim(arr(i)))
                    If dict.exists(fVal) Then
                        For Each temp In dict(fVal).Items
                            If Not validChildren.exists(LCase(temp)) Then
                                validChildren.Add LCase(temp), temp
                            End If
                        Next temp
                    End If
                Next i
            End If
            With cell.Offset(0, 1).Validation
                .Delete
                If validChildren.Count > 0 Then
                    Dim childList As String: childList = ""
                    For Each temp In validChildren.Items
                        If childList = "" Then
                            childList = temp
                        Else
                            childList = childList & "," & temp
                        End If
                    Next temp
                    .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:=childList
                End If
            End With
            ' Remove invalid G selections
            If cell.Offset(0, 1).Value <> "" Then
                arr = Split(cell.Offset(0, 1).Value, sep)
                Dim gVal As String: gVal = ""
                For i = LBound(arr) To UBound(arr)
                    temp = Trim(arr(i))
                    If temp <> "" Then
                        If validChildren.exists(LCase(temp)) Then
                            If gVal = "" Then
                                gVal = temp
                            Else
                                gVal = gVal & sep & temp
                            End If
                        End If
                    End If
                Next i
                cell.Offset(0, 1).Value = gVal
                cell.Offset(0, 1).WrapText = True
            End If
        End If

        ' MULTI-SELECT FOR G COLUMN
        If Not Intersect(cell, rngG) Is Nothing Then
            If cell.Validation.Type = 3 And cell.Value <> "" Then
                newVal = cell.Value
                oldVal = cell.Tag
                If oldVal = "" Then
                    cell.Value = newVal
                Else
                    arr = Split(oldVal, sep)
                    exists = False
                    For i = LBound(arr) To UBound(arr)
                        If arr(i) = newVal Then exists = True
                    Next i
                    Set tempList = CreateObject("Scripting.Dictionary")
                    If exists Then
                        ' Remove value
                        For i = LBound(arr) To UBound(arr)
                            If arr(i) <> newVal And arr(i) <> "" Then tempList(arr(i)) = 1
                        Next i
                        If tempList.Count > 0 Then
                            cell.Value = Join(tempList.Keys, sep)
                        Else
                            cell.Value = ""
                        End If
                    Else
                        ' Add value
                        cell.Value = oldVal & sep & newVal
                    End If
                End If
                cell.WrapText = True
            End If
            cell.Tag = cell.Value

            ' Update G dropdown for this row
            Set validChildren = CreateObject("Scripting.Dictionary")
            If cell.Offset(0, -1).Value <> "" Then
                arr = Split(cell.Offset(0, -1).Value, sep)
                For i = LBound(arr) To UBound(arr)
                    fVal = LCase(Trim(arr(i)))
                    If dict.exists(fVal) Then
                        For Each temp In dict(fVal).Items
                            If Not validChildren.exists(LCase(temp)) Then
                                validChildren.Add LCase(temp), temp
                            End If
                        Next temp
                    End If
                Next i
            End If
            With cell.Validation
                .Delete
                If validChildren.Count > 0 Then
                    Dim childList2 As String: childList2 = ""
                    For Each temp In validChildren.Items
                        If childList2 = "" Then
                            childList2 = temp
                        Else
                            childList2 = childList2 & "," & temp
                        End If
                    Next temp
                    .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:=childList2
                End If
            End With
        End If
    Next cell

CleanUp:
    Application.EnableEvents = True
End Sub

